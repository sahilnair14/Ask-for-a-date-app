name: Deploy Node.js Application to IIS

on:
  push:
    branches:
      - main  # Triggers deployment on push to the main branch

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'  # Specify your required Node.js version

    - name: Install dependencies
      run: npm install

    - name: Build the project
      run: npm run build  # Adjust this if you have a specific build step

    - name: Archive application
      run: |
        New-Item -ItemType Directory -Path ./deploy
        Copy-Item -Path ./* -Exclude ./node_modules,./.git,./deploy,./.github -Destination ./deploy -Recurse
        Compress-Archive -Path ./deploy/* -DestinationPath ./deploy.zip

    - name: Install Web Deploy
      run: |
        choco install webdeploy -y
        webpicmd /install /products:WDeployAdmin /AcceptEula

    - name: Deploy to IIS
      run: |
        $env:PATH = "$env:PATH;C:\Program Files\IIS\Microsoft Web Deploy V3\"
        msdeploy -verb:sync -source:package='./deploy.zip' -dest:iisApp='Default Web Site/MyApp',ComputerName='https://$env:IIS_SERVER:8172/msdeploy.axd',UserName='$env:IIS_USERNAME',Password='$env:IIS_PASSWORD',AuthType='Basic'
      env:
        IIS_SERVER: ${{ secrets.IIS_SERVER }}
        IIS_USERNAME: ${{ secrets.IIS_USERNAME }}
        IIS_PASSWORD: ${{ secrets.IIS_PASSWORD }}

    - name: Verify Deployment
      run: |
        Write-Host "Node.js application deployed successfully!"
